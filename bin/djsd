#!/usr/bin/env ruby

daemon_mode = false

if (%w( -h --help -help help ) & ARGV).length > 0
  puts "usage: djsd [-hvd]"
  puts "option(s):"
  puts "-d | daemon mode (background)"
  puts "starts dotjs server in the foreground. kill with ^C"
  exit
end

if ARGV.include?('-v')
  puts "djsd 2.0"
  exit
end

if ARGV.include?('-d')
  daemon_mode = true
end

require 'webrick'
require 'webrick/https'

dotjs = Class.new(WEBrick::HTTPServlet::AbstractServlet) do
  def do_GET(request, response)
    body = build_body(request.path)

    response.status = body.empty? ? 204 : 200
    if origin = detect_origin(request)
      response['Access-Control-Allow-Origin'] = origin
    end
    response['Content-Type'] = 'text/javascript'
    response.body = body
  end

  def build_body(path)
    files = [File.expand_path("~/.js/default.js")]
    paths = path.gsub('/','').split('.')

    until paths.empty?
      file = File.expand_path("~/.js/#{paths.join('.')}")
      files << file if File.file?(file)
      paths.shift
    end

    body = "// dotjs is working! //\n"

    files.each do |file|
      body << File.read(file) + "\n" if File.file?(file)
    end

    body
  end

  def detect_origin(req)
    path   = req.path
    origin = req.header['origin']
    search = path.gsub('/','').gsub(/\.js$/,'') + '$'

    if origin.length == 1 && path.length != 1 && origin[0].match(search)
      origin[0]
    end
  end
end

ssl_info = DATA.read
ssl_cert = ssl_info.scan(/(-----BEGIN CERTIFICATE-----.+?-----END CERTIFICATE-----)/m)[0][0]
ssl_key  = ssl_info.scan(/(-----BEGIN RSA PRIVATE KEY-----.+?-----END RSA PRIVATE KEY-----)/m)[0][0]

server_options = {
  :BindAddress => "127.0.0.1",
  :Port => 3131,
  :AccessLog => [],
  :SSLEnable => true,
  :SSLVerifyClient => OpenSSL::SSL::VERIFY_NONE,
  :SSLPrivateKey => OpenSSL::PKey::RSA.new(ssl_key),
  :SSLCertificate => OpenSSL::X509::Certificate.new(ssl_cert),
  :SSLCertName => [["CN", WEBrick::Utils::getservername]],
}

if daemon_mode
  server_options[:ServerType] = WEBrick::Daemon
end

server = WEBrick::HTTPServer.new(server_options)
server.mount('/', dotjs)

%w( INT TERM ).each do |sig|
  trap(sig) { server.shutdown }
end

server.start

__END__
-----BEGIN CERTIFICATE-----
MIIFhzCCA2+gAwIBAgIJALlvTu16kCFRMA0GCSqGSIb3DQEBCwUAME8xCzAJBgNV
BAYTAk5MMQswCQYDVQQIDAJPVjEPMA0GA1UEBwwGWndvbGxlMQ4wDAYDVQQKDAVE
b3RqczESMBAGA1UEAwwJbG9jYWxob3N0MB4XDTE3MDYyNjA2MDQ0MVoXDTE4MDYy
NjA2MDQ0MVowTzELMAkGA1UEBhMCTkwxCzAJBgNVBAgMAk9WMQ8wDQYDVQQHDAZa
d29sbGUxDjAMBgNVBAoMBURvdGpzMRIwEAYDVQQDDAlsb2NhbGhvc3QwggIiMA0G
CSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQCgJCnIZLbKJvEoSA2BjwzL1X+OZVb/
Ed61KrZLVCezUaoIyuWDtOXMJqUXy2eglA0hlPpsESAZVmrtN1C6T4EvpmOBqewy
cR96tiZgOllE5jznjmageRICHslqr7r8Kkf90HSzHjKinT2JBwlXCxgQTpnNHle8
3oWgj3keVbv8su9iIDEoBbaQ8lwM8BR/XeZhLD4kUCVzA35WH865JtvdKTOHJ/+b
Vmejsp9WWVhotX9VRKQMwtB66rv6XDB4S1OAyqqi2qS8DJjM88AloeMJXRjJ6iCl
cvMM1on688Fh5IuBGEF1E/e0+pK8IvTGDRMuVkCSAl80sOIl3QIZFrLwviR1JMiQ
ZzYXbac4sOIImtGVe8nrxwfRmiiPhozccHC9z63lXRpQVtX/OZhXMFWBhXTmYHbp
tdhewKbzVDW2D/5X1wCyzLddsZSL5Wnv5MVi27a5L9WJIfIqm0v/H66sBBbdGI/T
G9DeZISUzLuU2+urRLhasPENkQKBLNW1StQq8RPjjH0nH8cccoR0ACtRkusDtrau
DcujfJgmsJmz1LLoxZncUOPO5DWLGVBkVkCLcNdTeGnX1joayvAfGZLaUy41ReFD
PUtezafwoH2qU0BohpCSUxOUKwEoFYJpkrRWd9e2E/oERXQte/fH0hWNmB8pV4p1
8XmAKVLfGHbIEwIDAQABo2YwZDAUBgNVHREEDTALgglsb2NhbGhvc3QwHQYDVR0O
BBYEFEEknMHbWr1ffFkyvrWjeHrcqKLkMB8GA1UdIwQYMBaAFEEknMHbWr1ffFky
vrWjeHrcqKLkMAwGA1UdEwQFMAMBAf8wDQYJKoZIhvcNAQELBQADggIBADYJ5vhq
yztPh/ujIyRN1Nn8LaK2Hb1mi/yxXfA9RRXVE3M9DnKWaVzKL7yQ7trRdvVjeqkP
T8wd+jI8g31TwQA9qqIHkBo1AmA+yqBsY5pap+PA8+arj9DwDXcmf9EShS+el+t9
5ExVBuhGhBruV3pwH9KpC+pT+Wy2LkCsGsDLTTqErHJRJmDQ4YiBlz6HeesEObuz
f5+2Rvo/XsfFsWhxDdNxJcoSHCVFrV0kaxs9E6AlZaRyWXVjKSrheS/rRtVdzQc4
jKTJ/PL40jYC4z/T5+5J/oTfxuqUzNM7ZvsuAKMxP4Eql3NQwoRPIdNyDsh+tr7F
CgG6Jc1RRkf9LXh7XopomWlsgY9Isi6PhfiQ9ANr1G2MXWJNGMLLa71T7bmdTVV0
mO35/b68y+6dYMXNwLn2nsK3ENosXUUgKgO2Qi1uTIlD3nscNwT006mrsYKoA7gS
zP/ZnaMZafZWbxqLlRMxXevfi1ge43MnLu6LyO1ig5Pc0RxaIOGnnFIuExVuqDQa
3EUfXqQYv4ZXEXzfmv4Y737muuxyV5lR2ZpXKD2Q8LTdF5W6vhcEmxe1se4B3uYB
FH5OEOY+ymZXlnwQpcFBR7CgZsMeXw4dOIwqRWoWN3G4aY135eKq5KYhJkzmvKWL
QlPPQYJgNXa0wMLerRF44qT3jqCOwXJR/+PL
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
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
grL5AoIBAQCtcO6F4bj9HwXNDvo/vXyjJDrj2DzPB/SIH2Ibv4q4BtH6Y8K0MrC8
keKU5qrqF7FV9cye4PfeigHTR3UdKyajSo3t4sTQXMqRuoFTeYlRvSJM+QAM4I1h
KrFssmBolJOoK7bN+WptJxdWUKj6UugvGvUcFHfY8fjwB2UNwlitua8L3YoJojHO
Qe2wdzZm4cos9jdoSoqutadmHH262uwsqE0L7HjdaZI1E7fwHnMej4vRjjGz2g2t
PQ8FMa00YPdQ2vzPPh2qW9wm+M/vAuOt/HqIR5B34zamCY2JDzsTAvl6xWNGQUbG
lwZITmpMPWNCoOZlZJMkb02K4HltzVJDAoIBAQDOB0GjoXSLfq2hLi8KSlJw/f1i
l/1V6B9uRES5zV0rt9IXVwdUWL+HGkqEdBqzPAU25MReL99tbTab5L+85NekA6s6
3VoATUPC9Pax3pH+lC6PilWi/a4hPjLsC9uFqKOwfSj1Pa+fFfBjVAMK6aTOQobu
z3kr/diHQPJ1mK29qQy6t5nZBFWWzNxXcNadX9AdOcPNtvBFknDrr21A2dLGmjew
I3tmeFB1U7gJFmwXlIV1dDaX5p6l4nKbLPeXtZCQCuMdekGdVh0gm0qtiY1bjKCl
NxzBi9ImugAD483T0fBAkU84+ucWRRlddO+IdmfBB9tZ8V+tzNo+fmWn0JHL
-----END RSA PRIVATE KEY-----

